<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>South Police Run - Runner Portal</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
      -webkit-text-size-adjust: 100%;
    }
    
    /* Prevent zoom on mobile */
    input, select, textarea {
      font-size: 16px !important;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse-custom {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px rgba(234, 88, 12, 0.5); }
      50% { box-shadow: 0 0 20px rgba(234, 88, 12, 0.8); }
    }
    
    @keyframes confetti {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    
    @keyframes loading {
      0% { width: 0%; transform: translateX(-100%); }
      50% { width: 100%; transform: translateX(0); }
      100% { width: 0%; transform: translateX(100%); }
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    
    .animate-pulse-custom {
      animation: pulse-custom 2s infinite ease-in-out;
    }
    
    .animate-float {
      animation: float 3s ease-in-out infinite;
    }
    
    .animate-glow {
      animation: glow 2s ease-in-out infinite;
    }
    
    /* Bib number styling */
    .bib-number {
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .bib-number-large {
      font-size: clamp(2rem, 8vw, 5rem);
      letter-spacing: 4px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
    }
    
    /* Custom scrollbar */
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    
    /* Medal colors */
    .medal-bronze {
      background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
      color: #fbbf24;
    }
    
    .medal-silver {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
      color: #e5e7eb;
    }
    
    .medal-gold {
      background: linear-gradient(135deg, #854d0e 0%, #a16207 100%);
      color: #fde047;
    }
    
    .medal-platinum {
      background: linear-gradient(135deg, #0e7490 0%, #0891b2 100%);
      color: #a5f3fc;
    }
    
    .medal-diamond {
      background: linear-gradient(135deg, #3730a3 0%, #4f46e5 100%);
      color: #c7d2fe;
    }
    
    /* Mobile optimization */
    @media (max-width: 640px) {
      .mobile-full-height {
        min-height: 100vh;
        min-height: -webkit-fill-available;
      }
      
      .mobile-padding {
        padding: 1rem !important;
      }
      
      .mobile-text {
        font-size: 14px !important;
      }
      
      .mobile-heading {
        font-size: 1.5rem !important;
      }
      
      .mobile-bib {
        font-size: clamp(2.5rem, 12vw, 4rem) !important;
      }
    }
    
    /* Confetti */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      pointer-events: none;
      z-index: 1000;
    }
    
    /* Ribbon effect */
    .ribbon {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 120px;
      height: 120px;
      overflow: hidden;
      z-index: 20;
    }
    
    .ribbon span {
      position: absolute;
      display: block;
      width: 200px;
      padding: 8px 0;
      background: linear-gradient(45deg, #ea580c 0%, #f59e0b 100%);
      color: white;
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }
    
    .ribbon span:nth-child(1) {
      transform: rotate(45deg);
      top: 25px;
      right: -40px;
    }
    
    /* Crown styles */
    .crown-gold {
      background: linear-gradient(135deg, #FFD700 0%, #FFEC8B 100%);
      color: #8B7500;
    }
    
    .crown-silver {
      background: linear-gradient(135deg, #C0C0C0 0%, #E8E8E8 100%);
      color: #696969;
    }
    
    .crown-bronze {
      background: linear-gradient(135deg, #CD7F32 0%, #E8B886 100%);
      color: #8B4513;
    }
    
    /* Input focus styles */
    input:focus, textarea:focus, select:focus {
      outline: none !important;
      box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.2) !important;
    }
    
    /* Activity log form styles */
    .activity-type-btn.active {
      border-color: #ea580c;
      background-color: rgba(234, 88, 12, 0.1);
      color: #ea580c;
    }
    
    /* Custom scrollbar for webkit */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #ea580c;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #c2410c;
    }
    
    /* Calendar styles */
    .calendar-container {
      position: relative;
    }
    
    .calendar-input {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      width: 100%;
      cursor: pointer;
    }
    
    .calendar-popup {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      z-index: 50;
      padding: 1rem;
      margin-top: 0.5rem;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }
    
    .calendar-day {
      text-align: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .calendar-day:hover {
      background-color: #f3f4f6;
    }
    
    .calendar-day.selected {
      background-color: #ea580c;
      color: white;
    }
    
    .calendar-day.disabled {
      color: #d1d5db;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300">
  <div id="app"></div>

  <script>
 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAEPb1cV5ThxVni1_W_dCRAn8wl_v6otew",
  authDomain: "track-afb50.firebaseapp.com",
  databaseURL: "https://track-afb50-default-rtdb.firebaseio.com",
  projectId: "track-afb50",
  storageBucket: "track-afb50.firebasestorage.app",
  messagingSenderId: "575348564273",
  appId: "1:575348564273:web:f5c0181b26fa8f2bb69010",
  measurementId: "G-W5SRFYRTQC"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // Application State
    let currentUser = null;
    let isDarkMode = false;
    let activeTab = 'dashboard';
    let isSidebarOpen = false;
    let totalRegisteredRunners = 0;
    let nextBibNumber = 1000;
    let isLogActivityModalOpen = false;
    let selectedDate = new Date();
    let filterRunner = 'all';

    // PNG Image URLs
    const BACKGROUND_IMAGE = '6059996227148910161.jpg';
    const BIB_BACKGROUND = '6059996227148910161.jpg';
    const RUNNER_BACKGROUND = '6059996227148910161.jpg';

    // DOM Elements
    const app = document.getElementById('app');

    // Initialize Application
    async function initApp() {
      // Check for saved user
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
      }
      
      // Get total registered runners count
      try {
        const snapshot = await db.ref('runners').once('value');
        if (snapshot.exists()) {
          totalRegisteredRunners = snapshot.numChildren();
          
          // Find the highest Bib number
          let highestBib = 999;
          snapshot.forEach(childSnapshot => {
            const runner = childSnapshot.val();
            if (runner.bib_number) {
              const bibNum = parseInt(runner.bib_number.replace('BIB-', ''));
              if (!isNaN(bibNum) && bibNum > highestBib) {
                highestBib = bibNum;
              }
            }
          });
          
          nextBibNumber = Math.max(1000, highestBib + 1);
        }
      } catch (error) {
        console.log('Error fetching runner count:', error);
      }

      // Show splash screen
      showSplashScreen();
    }

    // Splash Screen
    function showSplashScreen() {
      app.innerHTML = `
        <div class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-gradient-to-br from-blue-900 to-teal-900 mobile-full-height">
          <div class="w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-3xl shadow-2xl flex items-center justify-center mb-4 sm:mb-6 animate-bounce">
            <div class="text-orange-600 text-3xl sm:text-4xl font-bold">üèÉ‚Äç‚ôÇÔ∏è</div>
          </div>
          <h1 class="text-2xl sm:text-4xl font-extrabold text-white tracking-tight text-center px-4">South Police Run</h1>
          <p class="mt-2 text-base sm:text-xl text-white/80 font-medium text-center px-4">Official Runner Portal</p>
          <div class="mt-8 sm:mt-12 w-48 h-1 bg-white/20 rounded-full overflow-hidden">
            <div class="h-full bg-white" style="animation: loading 2s ease-in-out infinite;"></div>
          </div>
          <p class="mt-4 text-white/40 text-xs sm:text-sm text-center px-4">Powered by South Police Department</p>
        </div>
      `;

      setTimeout(() => {
        if (currentUser) {
          renderMainApp();
        } else {
          renderLogin();
        }
      }, 2000);
    }

    // Login Component with PNG Background
    function renderLogin(isRegister = false) {
      app.innerHTML = `
        <div class="min-h-screen mobile-full-height flex items-center justify-center p-4 sm:p-6 relative overflow-hidden" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BACKGROUND_IMAGE}') center/cover no-repeat fixed;">
          <!-- Background Overlay -->
          <div class="absolute inset-0 bg-black/50"></div>
          
          <div class="w-full max-w-4xl bg-white/10 backdrop-blur-xl p-6 sm:p-10 rounded-3xl sm:rounded-[3rem] border border-white/10 shadow-2xl relative z-10 animate-fadeIn mobile-padding">
            <div class="text-center mb-8 sm:mb-10">
              <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white rounded-2xl flex items-center justify-center mx-auto mb-4 sm:mb-6 shadow-xl shadow-orange-600/20">
                <div class="text-orange-600 text-xl sm:text-2xl font-bold">üèÉ‚Äç‚ôÇÔ∏è</div>
              </div>
              <h2 class="text-2xl sm:text-4xl font-black text-white uppercase tracking-tighter">
                ${isRegister ? 'Join South Police Run' : 'Runner Login'}
              </h2>
              <p class="text-white/60 font-medium mt-2 text-sm sm:text-base">${isRegister ? 'Register to get your Official Digital Bib' : 'Enter your Bib or Contact Number'}</p>
            </div>

            <div class="flex flex-col lg:flex-row gap-6 sm:gap-10">
              <!-- Registration/Login Form -->
              <div class="lg:w-2/3">
                <form id="authForm" class="space-y-4">
                  ${isRegister ? `
                    <div class="space-y-1">
                      <label class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-4">Full Name *</label>
                      <input 
                        required
                        type="text" 
                        id="name"
                        placeholder="Officer Name"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 sm:py-4 px-4 sm:px-6 text-white font-bold placeholder:text-white/20 focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-all text-base"
                      />
                    </div>
                    <div class="space-y-1">
                      <label class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-4">Nickname *</label>
                      <input 
                        required
                        type="text" 
                        id="nickname"
                        placeholder="Call Sign / Nickname"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 sm:py-4 px-4 sm:px-6 text-white font-bold placeholder:text-white/20 focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-all text-base"
                      />
                    </div>
                    <div class="space-y-1">
                      <label class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-4">Contact Number *</label>
                      <input 
                        required
                        type="tel" 
                        id="contact"
                        placeholder="+91 00000 00000"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 sm:py-4 px-4 sm:px-6 text-white font-bold placeholder:text-white/20 focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-all text-base"
                      />
                    </div>
                    <div class="space-y-1">
                      <label class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-4">Password *</label>
                      <input 
                        required
                        type="password" 
                        id="password"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 sm:py-4 px-4 sm:px-6 text-white font-bold placeholder:text-white/20 focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-all text-base"
                      />
                    </div>
                  ` : `
                    <div class="space-y-1">
                      <label class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-4">Bib Number / Contact Number *</label>
                      <input 
                        required
                        type="text" 
                        id="loginId"
                        placeholder="BIB-1000 or Contact Number"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 sm:py-4 px-4 sm:px-6 text-white font-bold placeholder:text-white/20 focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-all text-base"
                      />
                    </div>
                    <div class="space-y-1">
                      <label class="text-[10px] font-black text-white/40 uppercase tracking-widest ml-4">Password *</label>
                      <input 
                        required
                        type="password" 
                        id="password"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 sm:py-4 px-4 sm:px-6 text-white font-bold placeholder:text-white/20 focus:ring-2 focus:ring-orange-600 focus:border-transparent transition-all text-base"
                      />
                    </div>
                  `}

                  <button 
                    type="submit"
                    id="submitBtn"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-black py-4 sm:py-5 rounded-2xl mt-4 shadow-xl shadow-orange-600/20 transition-all active:scale-95 text-base sm:text-lg"
                  >
                    ${isRegister ? 'JOIN RUN & GET BIB' : 'LOGIN'}
                  </button>
                </form>

                <div class="mt-6 sm:mt-8 text-center">
                  <button 
                    id="toggleAuth"
                    class="text-white/60 hover:text-white text-xs sm:text-sm font-bold uppercase tracking-widest transition-colors"
                  >
                    ${isRegister ? 'Already have a Bib? Login' : "Don't have a Bib? Join Run"}
                  </button>
                </div>
              </div>

              <!-- Digital Bib Preview with PNG Background -->
              <div class="lg:w-1/3">
                <div class="rounded-3xl p-6 sm:p-8 h-full relative overflow-hidden border-4 border-orange-600/50" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BIB_BACKGROUND}') center/cover no-repeat;">
                  <div class="relative z-10">
                    <div class="text-center mb-6">
                      <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-2">Your Digital Bib</p>
                      <div class="bib-number bib-number-large font-black text-white mb-4 tracking-wider animate-pulse">
                        ${isRegister ? `BIB-${nextBibNumber}` : 'BIB-XXXX'}
                      </div>
                      <div class="bg-black/50 backdrop-blur-sm rounded-2xl p-4 sm:p-5 mb-4 border border-white/20">
                        <p class="text-white text-base sm:text-lg font-bold" id="previewName">${isRegister ? 'Your Name' : 'Runner Name'}</p>
                        <p class="text-white/80 text-sm" id="previewNickname">"${isRegister ? 'Your Nickname' : 'Nickname'}"</p>
                        <p class="text-white/60 text-sm mt-2" id="previewContact">${isRegister ? 'Your Contact' : 'Contact'}</p>
                      </div>
                      <p class="text-white/60 text-xs">Your official race identifier</p>
                    </div>
                    
                    <!-- Bib Features -->
                    <div class="space-y-3 mt-6 sm:mt-8">
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-orange-600/20 flex items-center justify-center">
                          <i class="fas fa-medal text-orange-400"></i>
                        </div>
                        <div>
                          <p class="text-xs font-bold text-white">Earn Digital Medals</p>
                          <p class="text-[10px] text-orange-300">50km, 100km, 250km milestones</p>
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-orange-600/20 flex items-center justify-center">
                          <i class="fas fa-trophy text-orange-400"></i>
                        </div>
                        <div>
                          <p class="text-xs font-bold text-white">Join Leaderboard</p>
                          <p class="text-[10px] text-orange-300">Compete with other runners</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="absolute bottom-6 left-0 right-0 text-center">
              <p class="text-white/30 text-[10px] font-black uppercase tracking-[0.2em]">Developed by Ahmed Vaseem</p>
            </div>
          </div>
        </div>
      `;

      // Update preview when user types in registration form
      if (isRegister) {
        const nameInput = document.getElementById('name');
        const nicknameInput = document.getElementById('nickname');
        const contactInput = document.getElementById('contact');
        
        if (nameInput) {
          nameInput.addEventListener('input', () => {
            document.getElementById('previewName').textContent = nameInput.value || 'Your Name';
          });
        }
        
        if (nicknameInput) {
          nicknameInput.addEventListener('input', () => {
            document.getElementById('previewNickname').textContent = `"${nicknameInput.value || 'Your Nickname'}"`;
          });
        }
        
        if (contactInput) {
          contactInput.addEventListener('input', () => {
            document.getElementById('previewContact').textContent = contactInput.value || 'Your Contact';
          });
        }
      }

      // Add event listeners
      document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
      document.getElementById('toggleAuth').addEventListener('click', () => {
        renderLogin(!isRegister);
      });
    }

    // Generate unique Bib number
    function generateBibNumber() {
      const bibNum = nextBibNumber++;
      return `BIB-${bibNum}`;
    }

    // Authentication Handler
    async function handleAuthSubmit(e) {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      const isRegister = document.getElementById('name') !== null;

      submitBtn.disabled = true;
      submitBtn.textContent = isRegister ? 'GENERATING BIB...' : 'AUTHENTICATING...';

      try {
        if (isRegister) {
          const name = document.getElementById('name').value;
          const nickname = document.getElementById('nickname').value;
          const contact = document.getElementById('contact').value;
          const password = document.getElementById('password').value;
          
          // Generate unique Bib number
          const bibNumber = generateBibNumber();
          
          // Create user in Firebase Auth
          const userCredential = await auth.createUserWithEmailAndPassword(
            `${contact}@southpolice.run`,
            password
          );
          
          // Save user data to Realtime Database
          const userData = {
            bib_number: bibNumber,
            name: name,
            nickname: nickname,
            contact: contact,
            status: 'active',
            registration_date: new Date().toISOString(),
            total_runs: 0,
            total_distance: 0,
            avg_pace: 0,
            medals: [],
            last_activity_date: null
          };
          
          await db.ref(`runners/${bibNumber}`).set(userData);

          // Update total runners count
          totalRegisteredRunners++;

          // Show Bib assignment success
          currentUser = userData;
          showBibAssignment(bibNumber);
          
        } else {
          // Login with Bib or Contact
          const loginId = document.getElementById('loginId').value;
          const password = document.getElementById('password').value;
          
          let userData = null;
          
          // Try to find by Bib number first
          const bibSnapshot = await db.ref(`runners/${loginId}`).once('value');
          if (bibSnapshot.exists()) {
            userData = bibSnapshot.val();
          } else {
            // Try to find by contact number
            const snapshot = await db.ref('runners').orderByChild('contact').equalTo(loginId).once('value');
            if (snapshot.exists()) {
              snapshot.forEach(childSnapshot => {
                userData = childSnapshot.val();
              });
            }
          }
          
          if (!userData) {
            throw new Error('Invalid Bib number or contact number');
          }
          
          // Login with contact as email
          const userCredential = await auth.signInWithEmailAndPassword(
            `${userData.contact}@southpolice.run`,
            password
          );
          
          currentUser = userData;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Show login success with Digital Bib
          showLoginSuccess(currentUser);
        }
      } catch (error) {
        alert(error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = isRegister ? 'JOIN RUN & GET BIB' : 'LOGIN';
      }
    }

    // Show Login Success with Digital Bib and PNG Background
    function showLoginSuccess(user) {
      app.innerHTML = `
        <div class="min-h-screen mobile-full-height flex items-center justify-center p-4 sm:p-6 relative overflow-hidden" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BACKGROUND_IMAGE}') center/cover no-repeat fixed;">
          <!-- Background Overlay -->
          <div class="absolute inset-0 bg-black/50"></div>
          
          <!-- Confetti effect -->
          <div id="confettiContainer"></div>
          
          <!-- Success Message Container -->
          <div class="w-full max-w-4xl bg-white/10 backdrop-blur-xl p-6 sm:p-10 rounded-3xl sm:rounded-[3rem] border border-white/10 shadow-2xl relative z-10 animate-fadeIn mobile-padding">
            <!-- Ribbon -->
            <div class="ribbon">
              <span>Welcome Back</span>
            </div>
            
            <!-- Success Header -->
            <div class="text-center mb-8 sm:mb-10">
              <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-tr from-orange-600 to-amber-500 rounded-3xl flex items-center justify-center mx-auto mb-4 sm:mb-6 shadow-2xl shadow-orange-600/30 animate-bounce">
                <i class="fas fa-check text-2xl sm:text-3xl text-white"></i>
              </div>
              <h2 class="text-2xl sm:text-4xl font-black text-white uppercase tracking-tighter">Login Successful!</h2>
              <p class="text-white/60 font-medium mt-2 text-sm sm:text-base">Welcome back to South Police Run Portal</p>
            </div>
            
            <!-- Digital Bib Card with PNG Background -->
            <div class="mb-8 sm:mb-10">
              <div class="rounded-3xl p-6 sm:p-8 relative overflow-hidden border-4 border-orange-600/50" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BIB_BACKGROUND}') center/cover no-repeat;">
                <div class="relative z-10">
                  <div class="text-center">
                    <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-2">Your Official Digital Bib</p>
                    <div class="bib-number bib-number-large font-black text-white mb-4 sm:mb-6 tracking-wider animate-pulse-custom">${user.bib_number}</div>
                    
                    <div class="bg-black/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border border-white/20">
                      <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                        <div class="w-12 h-12 sm:w-16 sm:h-16 rounded-2xl bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-white text-base sm:text-xl font-bold">
                          ${user.nickname ? user.nickname.substring(0, 2).toUpperCase() : 'RU'}
                        </div>
                        <div class="text-center sm:text-left">
                          <p class="text-xl sm:text-2xl font-black text-white">${user.name}</p>
                          <p class="text-lg sm:text-xl text-orange-300">"${user.nickname}"</p>
                          <p class="text-sm text-white/60 mt-1">${user.contact}</p>
                        </div>
                      </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-3 mt-4">
                      <div class="flex items-center gap-1.5">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <p class="text-xs font-bold text-green-400">ACTIVE RUNNER</p>
                      </div>
                      <span class="text-white/40 hidden sm:inline">‚Ä¢</span>
                      <p class="text-xs text-white/60">Joined ${new Date(user.registration_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Next Medal Progress -->
            <div class="bg-gradient-to-br from-orange-600 to-amber-500 rounded-3xl p-4 sm:p-6 mb-6 sm:mb-8 shadow-xl shadow-orange-600/20">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h3 class="text-base sm:text-lg font-black text-white">Next Medal Progress</h3>
                  <p class="text-white/80 text-xs sm:text-sm">Keep running to earn your next achievement!</p>
                </div>
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md">
                  <i class="fas fa-medal text-lg sm:text-xl text-white"></i>
                </div>
              </div>
              
              ${getNextMedalGoal(user.total_distance || 0)}
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
              <button 
                id="continueToPortal"
                class="flex-1 bg-white hover:bg-gray-100 text-orange-600 font-black py-3 sm:py-4 px-4 sm:px-8 rounded-2xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2 sm:gap-3 text-sm sm:text-base"
              >
                <i class="fas fa-arrow-right"></i>
                CONTINUE TO PORTAL
              </button>
              <button 
                id="shareBibBtn"
                class="flex-1 bg-transparent hover:bg-white/10 text-white font-bold py-3 sm:py-4 px-4 sm:px-8 rounded-2xl border-2 border-white/20 transition-all active:scale-95 flex items-center justify-center gap-2 sm:gap-3 text-sm sm:text-base"
              >
                <i class="fas fa-share-alt"></i>
                SHARE BIB
              </button>
            </div>
          </div>
        </div>
      `;

      // Add confetti effect
      createConfetti();

      // Add event listeners
      document.getElementById('continueToPortal').addEventListener('click', () => {
        renderMainApp();
      });

      document.getElementById('shareBibBtn').addEventListener('click', () => {
        shareBib(user);
      });
    }

    // Create confetti effect
    function createConfetti() {
      const container = document.getElementById('confettiContainer');
      if (!container) return;
      
      const colors = ['#ea580c', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6'];
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        confetti.style.animation = `confetti ${Math.random() * 3 + 2}s linear ${Math.random() * 2}s forwards`;
        container.appendChild(confetti);
        
        // Remove confetti after animation
        setTimeout(() => {
          if (confetti.parentNode) {
            confetti.parentNode.removeChild(confetti);
          }
        }, 5000);
      }
    }

    // Show Bib Assignment with PNG Background
    function showBibAssignment(bibNumber) {
      app.innerHTML = `
        <div class="min-h-screen mobile-full-height flex items-center justify-center p-4 sm:p-6 relative overflow-hidden" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BACKGROUND_IMAGE}') center/cover no-repeat fixed;">
          <!-- Background Overlay -->
          <div class="absolute inset-0 bg-black/50"></div>

          <div class="w-full max-w-2xl bg-white/10 backdrop-blur-xl p-6 sm:p-10 rounded-3xl sm:rounded-[3rem] border border-white/10 shadow-2xl relative z-10 animate-fadeIn mobile-padding">
            <div class="text-center mb-8 sm:mb-10">
              <div class="w-16 h-16 sm:w-20 sm:h-20 bg-white rounded-2xl flex items-center justify-center mx-auto mb-4 sm:mb-6 shadow-xl shadow-orange-600/20">
                <div class="text-orange-600 text-2xl sm:text-3xl font-bold">üèÖ</div>
              </div>
              <h2 class="text-2xl sm:text-4xl font-black text-white uppercase tracking-tighter">Welcome to South Police Run!</h2>
              <p class="text-white/60 font-medium mt-2 text-sm sm:text-base">Your Digital Runner Bib has been assigned</p>
            </div>

            <!-- Bib Card with PNG Background -->
            <div class="rounded-3xl p-6 sm:p-8 mb-6 sm:mb-8 relative overflow-hidden border-4 border-orange-600/50" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BIB_BACKGROUND}') center/cover no-repeat;">
              <div class="text-center">
                <p class="text-white/80 text-sm font-bold uppercase tracking-widest mb-2">Your Official Bib Number</p>
                <div class="bib-number mobile-bib font-black text-white mb-4 tracking-wider">${bibNumber}</div>
                <div class="bg-black/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 mb-4 border border-white/20">
                  <p class="text-white text-base sm:text-lg font-bold">${currentUser.name}</p>
                  <p class="text-white/80 text-sm">"${currentUser.nickname}"</p>
                  <p class="text-white/60 text-sm mt-2">${currentUser.contact}</p>
                </div>
                <p class="text-white/60 text-xs">Use this Bib number for all race activities</p>
              </div>
            </div>

            <div class="text-center space-y-4">
              <div class="p-3 sm:p-4 bg-white/5 rounded-2xl">
                <p class="text-white/80 text-sm font-medium mb-2">Your Bib number is unique and permanent</p>
                <p class="text-white/60 text-xs">Starting from BIB-1000, each new runner gets the next sequential number</p>
              </div>
              
              <p class="text-white/60 text-sm">Save your Bib number for future logins</p>
              <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
                <button 
                  id="continueBtn"
                  class="bg-white hover:bg-gray-100 text-orange-600 font-black py-3 sm:py-4 px-4 sm:px-8 rounded-2xl shadow-xl transition-all active:scale-95 text-sm sm:text-base"
                >
                  CONTINUE TO PORTAL
                </button>
                <button 
                  id="printBibBtn"
                  class="bg-transparent hover:bg-white/10 text-white font-bold py-3 sm:py-4 px-4 sm:px-8 rounded-2xl border-2 border-white/20 transition-all active:scale-95 text-sm sm:text-base"
                >
                  PRINT BIB
                </button>
              </div>
              <p class="text-white/40 text-xs mt-4 sm:mt-6">You can also login using your contact number</p>
            </div>
          </div>
        </div>
      `;

      document.getElementById('continueBtn').addEventListener('click', () => {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        renderMainApp();
      });

      document.getElementById('printBibBtn').addEventListener('click', () => {
        window.print();
      });
    }

    // Get next medal goal
    function getNextMedalGoal(currentDistance) {
      const medalGoals = [
        { distance: 50, name: "Bronze", color: "bronze", icon: "fas fa-medal" },
        { distance: 100, name: "Silver", color: "silver", icon: "fas fa-medal" },
        { distance: 250, name: "Gold", color: "gold", icon: "fas fa-medal" },
        { distance: 500, name: "Platinum", color: "platinum", icon: "fas fa-gem" },
        { distance: 1000, name: "Diamond", color: "diamond", icon: "fas fa-gem" }
      ];
      
      let nextMedal = null;
      for (const medal of medalGoals) {
        if (currentDistance < medal.distance) {
          nextMedal = medal;
          break;
        }
      }
      
      if (!nextMedal) {
        return `
          <div class="text-center py-2">
            <p class="text-lg font-black">üèÜ CHAMPION! üèÜ</p>
            <p class="text-sm mt-1">You've earned all medals! Legend status achieved.</p>
          </div>
        `;
      }
      
      const progress = Math.min(100, Math.round((currentDistance / nextMedal.distance) * 100));
      
      return `
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 sm:gap-3">
              <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full medal-${nextMedal.color} flex items-center justify-center">
                <i class="${nextMedal.icon} text-sm sm:text-base"></i>
              </div>
              <div>
                <p class="font-bold text-white text-sm sm:text-base">${nextMedal.name} Medal</p>
                <p class="text-xs text-white/80">${nextMedal.distance} km</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-lg font-black text-white">${progress}%</p>
              <p class="text-xs text-white/80">Progress</p>
            </div>
          </div>
          
          <div class="w-full bg-white/20 rounded-full h-2">
            <div class="bg-white h-2 rounded-full" style="width: ${progress}%"></div>
          </div>
          
          <div class="flex justify-between text-xs text-white/80">
            <span>${currentDistance.toFixed(1)} km</span>
            <span>${nextMedal.distance} km</span>
          </div>
          
          <p class="text-xs text-center mt-2 text-white/90">
            ${nextMedal.distance - currentDistance > 0 ? 
              `Run ${(nextMedal.distance - currentDistance).toFixed(1)} more km to earn this medal!` : 
              'Almost there! Keep going!'}
          </p>
        </div>
      `;
    }

    // Share Bib function
    function shareBib(user) {
      if (navigator.share) {
        navigator.share({
          title: 'My South Police Run Digital Bib',
          text: `Check out my South Police Run Digital Bib! I'm ${user.name} (${user.nickname}) with Bib Number ${user.bib_number}`,
          url: window.location.href
        });
      } else {
        const text = `üèÉ‚Äç‚ôÇÔ∏è South Police Run Digital Bib\n\nName: ${user.name}\nNickname: ${user.nickname}\nBib Number: ${user.bib_number}\n\nJoin me at South Police Run!`;
        
        navigator.clipboard.writeText(text)
          .then(() => {
            alert('Bib details copied to clipboard!');
          })
          .catch(() => {
            alert('Could not copy Bib details. Please try again.');
          });
      }
    }

    // Main Application
    function renderMainApp() {
      app.innerHTML = `
        <div class="min-h-screen ${isDarkMode ? 'dark' : ''} mobile-full-height">
          <!-- Header -->
          <header class="fixed top-0 left-0 right-0 h-14 sm:h-16 bg-white dark:bg-zinc-800 border-b-2 border-orange-600 shadow-sm z-50 flex items-center justify-between px-3 sm:px-4 md:px-8">
            <div class="flex items-center gap-2 sm:gap-3">
              <button id="sidebarToggle" class="p-1.5 sm:p-2 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 dark:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
              </button>
              <div class="hidden sm:flex items-center gap-2">
                <div class="text-orange-600 text-xl sm:text-2xl">üèÉ‚Äç‚ôÇÔ∏è</div>
                <h1 class="text-lg sm:text-xl font-black text-orange-600 uppercase tracking-tighter">South Police Run</h1>
              </div>
              <div class="flex items-center gap-1 bg-orange-600 text-white text-[9px] sm:text-[10px] font-bold px-1.5 sm:px-2 py-0.5 rounded-full animate-pulse">
                <div class="w-1 h-1 sm:w-1.5 sm:h-1.5 bg-white rounded-full"></div>
                PORTAL
              </div>
            </div>

            <div class="flex items-center gap-1 sm:gap-2 md:gap-4">
              <div class="hidden sm:flex items-center gap-2 bg-orange-50 dark:bg-orange-900/20 p-1 pr-2 sm:p-1.5 sm:pr-3 rounded-full border border-orange-200 dark:border-orange-500/50">
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-white text-xs font-bold shadow-sm">
                  ${currentUser.bib_number ? currentUser.bib_number.split('-')[1]?.substring(0, 2) || 'BI' : 'BI'}
                </div>
                <div class="hidden md:block">
                  <p class="text-xs font-bold leading-tight dark:text-white">${currentUser.nickname}</p>
                  <p class="text-[10px] text-orange-600 dark:text-orange-400 font-black">${currentUser.bib_number}</p>
                </div>
              </div>

              <button id="logoutBtn" class="p-1.5 sm:p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
              </button>
            </div>
          </header>

          <!-- Sidebar -->
          ${renderSidebar()}

          <!-- Main Content -->
          <main class="flex-1 transition-all duration-300 mt-14 sm:mt-16 p-3 sm:p-4 md:p-8 ${isSidebarOpen ? 'md:ml-64' : ''} pb-20 sm:pb-0">
            <div class="max-w-6xl mx-auto">
              <div id="content"></div>
            </div>
          </main>

          <!-- Mobile Bottom Navigation with Plus Icon for Log Activity -->
          <div class="sm:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-800 border-t border-gray-200 dark:border-zinc-700 flex justify-around py-3 z-30">
            ${[
              { id: 'dashboard', icon: 'fas fa-home', label: 'Home' },
              { id: 'feed', icon: 'fas fa-newspaper', label: 'Feed' },
              { id: 'logActivity', icon: 'fas fa-plus-circle', label: 'Log', isPlus: true },
              { id: 'ranking', icon: 'fas fa-trophy', label: 'Ranking' },
              { id: 'activities', icon: 'fas fa-history', label: 'History' }
            ].map(item => {
              if (item.isPlus) {
                return `
                  <button 
                    id="mobileLogActivityBtn"
                    class="flex flex-col items-center gap-1 text-orange-600"
                  >
                    <div class="w-12 h-12 -mt-6 rounded-full bg-gradient-to-tr from-orange-600 to-amber-500 text-white shadow-xl flex items-center justify-center">
                      <i class="${item.icon} text-xl"></i>
                    </div>
                    <span class="text-[10px] font-medium">${item.label}</span>
                  </button>
                `;
              } else {
                return `
                  <button 
                    data-tab="${item.id}"
                    class="mobile-tab-btn flex flex-col items-center gap-0.5 ${activeTab === item.id ? 'text-orange-600' : 'text-gray-500 dark:text-gray-400'}"
                  >
                    <i class="${item.icon} text-lg"></i>
                    <span class="text-[10px] font-medium">${item.label}</span>
                  </button>
                `;
              }
            }).join('')}
          </div>
        </div>
      `;

      // Add event listeners
      document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('mobileLogActivityBtn').addEventListener('click', () => {
        isLogActivityModalOpen = true;
        renderLogActivityModal();
      });
      
      // Mobile tab buttons
      document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          activeTab = btn.dataset.tab;
          renderContent();
        });
      });

      // Initial content render
      renderContent();
    }

    // Sidebar Component with Activity Feed instead of Medals
    function renderSidebar() {
      const menuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
        { id: 'feed', label: 'Activity Feed', icon: 'fas fa-newspaper' },
        { id: 'ranking', label: 'Runners Ranking', icon: 'fas fa-trophy' },
        { id: 'leaderboard', label: '100km Leaders', icon: 'fas fa-crown' },
        { id: 'activities', label: 'My Activities', icon: 'fas fa-history' }
      ];

      return `
        ${isSidebarOpen ? `
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[55] md:hidden" id="sidebarOverlay"></div>
        ` : ''}
        <aside class="fixed top-14 sm:top-16 left-0 bottom-0 w-64 bg-zinc-900 text-white z-[60] transition-transform duration-300 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 overflow-y-auto border-r border-zinc-800 hide-scrollbar">
          <div class="p-4 sm:p-6">
            <div class="flex items-center gap-3 mb-6 sm:mb-8">
              <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-base sm:text-lg font-bold">
                ${currentUser.bib_number ? currentUser.bib_number.split('-')[1]?.substring(0, 2) || 'BI' : 'BI'}
              </div>
              <div>
                <p class="font-bold text-sm truncate w-32">${currentUser.nickname}</p>
                <p class="text-xs text-orange-500 font-semibold">${currentUser.bib_number}</p>
                <p class="text-xs text-gray-400 mt-1">${currentUser.name}</p>
              </div>
            </div>

            <nav class="space-y-1 mb-6 sm:mb-8">
              ${menuItems.map(item => `
                <button
                  data-tab="${item.id}"
                  class="sidebar-tab-btn w-full flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl transition-all ${activeTab === item.id ? 'bg-orange-600 text-white shadow-lg shadow-orange-600/20' : 'text-gray-400 hover:bg-zinc-800 hover:text-white'}"
                >
                  <i class="${item.icon} w-5 text-center"></i>
                  <span class="font-medium text-sm">${item.label}</span>
                </button>
              `).join('')}
            </nav>
            
            <!-- Digital Bib in Sidebar with PNG Background -->
            <div class="mb-6 sm:mb-8 rounded-2xl p-3 sm:p-4 relative overflow-hidden border-2 border-orange-600/50" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${RUNNER_BACKGROUND}') center/cover no-repeat;">
              <div class="relative z-10">
                <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-2 text-center">Your Digital Bib</p>
                <div class="bib-number text-2xl sm:text-3xl font-black text-center text-white mb-2">${currentUser.bib_number}</div>
                
                <div class="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-orange-500/30">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-xs text-orange-300">Total Distance</span>
                    <span class="text-sm font-bold text-white">${(currentUser.total_distance || 0).toFixed(1)} km</span>
                  </div>
                  <div class="w-full bg-white/10 rounded-full h-1.5 mb-2">
                    <div class="bg-gradient-to-r from-orange-500 to-amber-400 h-1.5 rounded-full" style="width: ${Math.min(100, ((currentUser.total_distance || 0) / 100) * 100)}%"></div>
                  </div>
                </div>
                
                <p class="text-xs text-gray-300 text-center">${currentUser.name}</p>
                <p class="text-xs text-orange-300 text-center mt-1">"${currentUser.nickname}"</p>
              </div>
            </div>

            <!-- Recent Activities in Sidebar -->
            <div class="mb-6 sm:mb-8">
              <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 sm:mb-4">Recent Activities</p>
              <div id="sidebarActivities" class="space-y-2">
                <div class="text-center py-4">
                  <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-orange-600 border-t-transparent"></div>
                  <p class="text-xs text-gray-400 mt-2">Loading activities...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="absolute bottom-6 left-4 right-4 sm:left-6 sm:right-6 p-3 sm:p-4 bg-zinc-800 rounded-2xl border border-zinc-700">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
              <div>
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Total Distance</p>
                <p class="text-base sm:text-lg font-black text-orange-500">${(currentUser.total_distance || 0).toFixed(1)} km</p>
              </div>
              <div class="p-1.5 sm:p-2 bg-zinc-700 rounded-lg">
                <div class="text-orange-500 text-lg sm:text-xl">üèÉ‚Äç‚ôÇÔ∏è</div>
              </div>
            </div>
            <button id="sidebarLogout" class="w-full py-2 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white text-xs font-bold rounded-lg border border-red-500/20 transition-all">
              Sign Out
            </button>
          </div>
        </aside>
      `;

      // Load sidebar activities
      setTimeout(() => loadSidebarActivities(), 100);
    }

    // Load sidebar activities
    async function loadSidebarActivities() {
      const sidebarActivities = document.getElementById('sidebarActivities');
      if (!sidebarActivities) return;

      try {
        const snapshot = await db.ref('running_logs').orderByChild('date').limitToLast(3).once('value');
        const activities = [];
        
        snapshot.forEach(childSnapshot => {
          const activity = childSnapshot.val();
          activity.id = childSnapshot.key;
          activities.push(activity);
        });

        // Sort by date (newest first)
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (activities.length === 0) {
          sidebarActivities.innerHTML = `
            <div class="text-center py-2">
              <p class="text-xs text-gray-400">No recent activities</p>
            </div>
          `;
          return;
        }

        sidebarActivities.innerHTML = activities.map(activity => {
          const activityDate = new Date(activity.date);
          const formattedDate = activityDate.toLocaleDateString('en-GB', { 
            day: 'numeric', 
            month: 'short' 
          });
          
          return `
            <div class="bg-zinc-800/50 p-2.5 sm:p-3 rounded-xl">
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 rounded-full bg-orange-600/20 flex items-center justify-center">
                    <i class="fas fa-running text-xs text-orange-400"></i>
                  </div>
                  <p class="text-xs font-medium truncate max-w-[100px]">${activity.nickname || activity.runner_name}</p>
                </div>
                <span class="text-[10px] text-gray-400">${formattedDate}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs font-bold text-orange-400">${activity.distance} km</span>
                <span class="text-[10px] text-gray-400">${activity.duration} min</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading sidebar activities:', error);
        sidebarActivities.innerHTML = `
          <div class="text-center py-2">
            <p class="text-xs text-gray-400">Error loading activities</p>
          </div>
        `;
      }
    }

    // Content Renderer
    function renderContent() {
      const content = document.getElementById('content');
      if (!content) return;

      switch (activeTab) {
        case 'dashboard':
          renderDashboard(content);
          break;
        case 'feed':
          renderActivityFeed(content);
          break;
        case 'ranking':
          renderRanking(content);
          break;
        case 'leaderboard':
          renderLeaderboard(content);
          break;
        case 'activities':
          renderMyActivities(content);
          break;
        default:
          renderDashboard(content);
      }

      // Update sidebar buttons
      updateSidebarButtons();
    }

    // Dashboard Component with Date Filter and Runner Filter
    async function renderDashboard(container) {
      // Fetch user stats from Firebase
      const snapshot = await db.ref(`runners/${currentUser.bib_number}`).once('value');
      const userData = snapshot.val() || currentUser;

      // Get all runners for filter
      let allRunners = [];
      try {
        const runnersSnapshot = await db.ref('runners').once('value');
        runnersSnapshot.forEach(childSnapshot => {
          const runner = childSnapshot.val();
          allRunners.push({
            bib_number: runner.bib_number,
            name: runner.name,
            nickname: runner.nickname,
            total_distance: runner.total_distance || 0
          });
        });
        
        // Sort runners by name for dropdown
        allRunners.sort((a, b) => a.name.localeCompare(b.name));
      } catch (error) {
        console.log('Error fetching runners:', error);
      }

      container.innerHTML = `
        <div class="space-y-4 sm:space-y-6 animate-fadeIn">
          <!-- Digital Bib Card with PNG Background -->
          <div class="rounded-3xl p-4 sm:p-6 relative overflow-hidden border-4 border-orange-600/50" style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${BIB_BACKGROUND}') center/cover no-repeat;">
            <div class="relative z-10">
              <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 sm:gap-4">
                <div class="flex-1">
                  <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-1">Official Digital Bib</p>
                  <div class="bib-number text-3xl sm:text-4xl md:text-5xl font-black text-white mb-2">${currentUser.bib_number}</div>
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-white text-xs sm:text-sm font-bold">
                      ${currentUser.nickname ? currentUser.nickname.substring(0, 2).toUpperCase() : 'RU'}
                    </div>
                    <div>
                      <p class="text-sm font-bold text-white">${currentUser.name}</p>
                      <p class="text-xs text-orange-300">"${currentUser.nickname}"</p>
                    </div>
                  </div>
                </div>
                <div class="flex flex-col items-center mt-3 md:mt-0">
                  <div class="w-12 h-12 sm:w-16 sm:h-16 md:w-20 md:h-20 bg-gradient-to-tr from-orange-600/20 to-amber-500/20 rounded-2xl flex items-center justify-center mb-2 backdrop-blur-sm border border-orange-500/30">
                    <i class="fas fa-running text-xl sm:text-2xl md:text-3xl text-orange-400"></i>
                  </div>
                  <p class="text-[10px] font-black text-orange-300 uppercase tracking-widest">Active Runner</p>
                </div>
              </div>
              
              <!-- Total Distance -->
              <div class="mt-4 sm:mt-6 pt-3 sm:pt-4 border-t border-orange-500/30">
                <div class="text-center mb-3">
                  <p class="text-xs text-orange-300 uppercase tracking-widest font-bold mb-1">Cumulative Distance</p>
                  <div class="text-2xl sm:text-3xl md:text-4xl font-black text-white">${(currentUser.total_distance || 0).toFixed(1)} <span class="text-base sm:text-lg text-orange-300">km</span></div>
                </div>
                
                <div class="space-y-2">
                  <div class="flex justify-between text-xs">
                    <span class="text-orange-300">Progress to 100km</span>
                    <span class="text-white font-bold">${Math.min(100, Math.round((currentUser.total_distance || 0) / 100 * 100))}%</span>
                  </div>
                  <div class="w-full bg-white/10 rounded-full h-2">
                    <div class="bg-gradient-to-r from-orange-500 to-amber-400 h-2 rounded-full" style="width: ${Math.min(100, ((currentUser.total_distance || 0) / 100) * 100)}%"></div>
                  </div>
                  <div class="flex justify-between text-[10px] text-orange-300">
                    <span>0 km</span>
                    <span>100 km</span>
                  </div>
                </div>
              </div>
              
              <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-orange-500/30">
                <div class="flex items-center justify-between">
                  <div class="text-center">
                    <p class="text-[10px] text-orange-300 uppercase tracking-widest">Status</p>
                    <div class="flex items-center gap-1.5 mt-1">
                      <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-500 rounded-full animate-pulse"></div>
                      <p class="text-xs font-bold text-white">ACTIVE</p>
                    </div>
                  </div>
                  <div class="text-center">
                    <p class="text-[10px] text-orange-300 uppercase tracking-widest">Joined</p>
                    <p class="text-xs font-bold text-white">${new Date(currentUser.registration_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                  </div>
                  <div class="text-center">
                    <p class="text-[10px] text-orange-300 uppercase tracking-widest">Contact</p>
                    <p class="text-xs font-bold text-white truncate max-w-[80px] sm:max-w-[100px]">${currentUser.contact}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Welcome Message -->
          <div>
            <h2 class="text-xl sm:text-2xl md:text-3xl font-black tracking-tight dark:text-white">Welcome back, ${currentUser.nickname}! üèÉ‚Äç‚ôÇÔ∏è</h2>
            <p class="text-gray-500 dark:text-gray-400 font-medium text-sm sm:text-base">Keep pushing your limits!</p>
          </div>

          <!-- Filters Section -->
          <div class="bg-white dark:bg-zinc-800 p-4 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-4">
              <!-- Date Filter -->
              <div class="flex-1">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Filter by Date</label>
                <div class="calendar-container">
                  <div class="calendar-input flex items-center justify-between">
                    <span id="selectedDateDisplay">${formatDate(selectedDate)}</span>
                    <i class="fas fa-calendar-alt text-gray-400"></i>
                  </div>
                  <div id="calendarPopup" class="calendar-popup hidden">
                    <div class="calendar-header">
                      <button id="prevMonth" class="p-1 hover:bg-gray-100 rounded">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      <h3 id="currentMonth" class="font-bold"></h3>
                      <button id="nextMonth" class="p-1 hover:bg-gray-100 rounded">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    <div id="calendarDays" class="calendar-grid"></div>
                  </div>
                </div>
              </div>
              
              <!-- Runner Filter -->
              <div class="flex-1">
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Filter by Runner</label>
                <select 
                  id="runnerFilter"
                  class="w-full bg-gray-50 dark:bg-zinc-700 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-orange-600 dark:text-white"
                >
                  <option value="all">All Runners</option>
                  ${allRunners.map(runner => `
                    <option value="${runner.bib_number}" ${filterRunner === runner.bib_number ? 'selected' : ''}>
                      ${runner.name} (${runner.bib_number})
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <!-- Apply Filter Button -->
            <button 
              id="applyFilter"
              class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2"
            >
              <i class="fas fa-filter"></i>
              APPLY FILTERS
            </button>
          </div>

          <!-- Filtered Results -->
          <div id="filteredResults" class="bg-white dark:bg-zinc-800 p-4 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold dark:text-white">Filtered Activities</h3>
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                <span class="text-xs text-gray-500 dark:text-gray-400">Live Results</span>
              </div>
            </div>
            <div id="filteredActivitiesList" class="space-y-3">
              <div class="text-center py-6">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-orange-600 border-t-transparent"></div>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading filtered activities...</p>
              </div>
            </div>
          </div>

          <!-- Stats Grid -->
          <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
            <div class="bg-white dark:bg-zinc-800 p-3 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700 hover:shadow-md transition-shadow group">
              <div class="bg-orange-600 w-8 h-8 sm:w-10 sm:h-10 rounded-xl sm:rounded-2xl flex items-center justify-center text-white mb-2 sm:mb-3 group-hover:scale-110 transition-transform">
                <i class="fas fa-running text-sm sm:text-base"></i>
              </div>
              <p class="text-xs font-semibold text-gray-500 dark:text-gray-400">Total Runs</p>
              <p class="text-lg sm:text-xl font-black mt-1 dark:text-white">${userData.total_runs || 0}</p>
            </div>
            <div class="bg-white dark:bg-zinc-800 p-3 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700 hover:shadow-md transition-shadow group">
              <div class="bg-blue-600 w-8 h-8 sm:w-10 sm:h-10 rounded-xl sm:rounded-2xl flex items-center justify-center text-white mb-2 sm:mb-3 group-hover:scale-110 transition-transform">
                <i class="fas fa-route text-sm sm:text-base"></i>
              </div>
              <p class="text-xs font-semibold text-gray-500 dark:text-gray-400">Total Distance</p>
              <p class="text-lg sm:text-xl font-black mt-1 dark:text-white">${(userData.total_distance || 0).toFixed(1)} km</p>
            </div>
            <div class="bg-white dark:bg-zinc-800 p-3 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700 hover:shadow-md transition-shadow group">
              <div class="bg-green-600 w-8 h-8 sm:w-10 sm:h-10 rounded-xl sm:rounded-2xl flex items-center justify-center text-white mb-2 sm:mb-3 group-hover:scale-110 transition-transform">
                <i class="fas fa-users text-sm sm:text-base"></i>
              </div>
              <p class="text-xs font-semibold text-gray-500 dark:text-gray-400">Total Runners</p>
              <p class="text-lg sm:text-xl font-black mt-1 dark:text-white">${allRunners.length}</p>
            </div>
            <div class="bg-white dark:bg-zinc-800 p-3 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700 hover:shadow-md transition-shadow group">
              <div class="bg-purple-600 w-8 h-8 sm:w-10 sm:h-10 rounded-xl sm:rounded-2xl flex items-center justify-center text-white mb-2 sm:mb-3 group-hover:scale-110 transition-transform">
                <i class="fas fa-tachometer-alt text-sm sm:text-base"></i>
              </div>
              <p class="text-xs font-semibold text-gray-500 dark:text-gray-400">Avg Pace</p>
              <p class="text-lg sm:text-xl font-black mt-1 dark:text-white">${(userData.avg_pace || 0).toFixed(1)} min/km</p>
            </div>
          </div>

          <!-- Registered Runners List -->
          <div class="bg-white dark:bg-zinc-800 p-4 sm:p-5 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-100 dark:border-zinc-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold dark:text-white">Registered Runners</h3>
              <span class="text-xs font-bold bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400 px-2 py-1 rounded-full">
                ${allRunners.length} Runners
              </span>
            </div>
            <div class="space-y-3 max-h-60 overflow-y-auto">
              ${allRunners.slice(0, 5).map(runner => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-zinc-700/50 rounded-xl">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-white text-xs font-bold">
                      ${runner.nickname ? runner.nickname.substring(0, 2).toUpperCase() : 'RU'}
                    </div>
                    <div>
                      <p class="text-sm font-bold dark:text-white">${runner.name}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">${runner.bib_number}</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-bold dark:text-white">${runner.total_distance.toFixed(1)} km</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Total</p>
                  </div>
                </div>
              `).join('')}
              
              ${allRunners.length > 5 ? `
                <div class="text-center pt-2">
                  <p class="text-sm text-gray-500 dark:text-gray-400">
                    +${allRunners.length - 5} more runners
                  </p>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      // Initialize calendar
      initializeCalendar();
      
      // Load filtered activities
      loadFilteredActivities();
      
      // Add event listeners
      document.getElementById('applyFilter').addEventListener('click', () => {
        filterRunner = document.getElementById('runnerFilter').value;
        loadFilteredActivities();
      });
      
      document.getElementById('runnerFilter').addEventListener('change', (e) => {
        filterRunner = e.target.value;
      });
    }

    // Format date for display
    function formatDate(date) {
      return date.toLocaleDateString('en-GB', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
      });
    }

    // Initialize calendar
    function initializeCalendar() {
      const calendarInput = document.querySelector('.calendar-input');
      const calendarPopup = document.getElementById('calendarPopup');
      const currentMonth = document.getElementById('currentMonth');
      const calendarDays = document.getElementById('calendarDays');
      const prevMonthBtn = document.getElementById('prevMonth');
      const nextMonthBtn = document.getElementById('nextMonth');
      const selectedDateDisplay = document.getElementById('selectedDateDisplay');
      
      let currentDate = new Date(selectedDate);
      let currentMonthYear = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      
      function updateCalendar() {
        // Update month display
        currentMonth.textContent = currentMonthYear.toLocaleDateString('en-GB', { 
          month: 'long', 
          year: 'numeric' 
        });
        
        // Clear previous days
        calendarDays.innerHTML = '';
        
        // Get first day of month
        const firstDay = new Date(currentMonthYear.getFullYear(), currentMonthYear.getMonth(), 1);
        const lastDay = new Date(currentMonthYear.getFullYear(), currentMonthYear.getMonth() + 1, 0);
        
        // Add day headers
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(day => {
          const dayElement = document.createElement('div');
          dayElement.className = 'text-center text-xs font-bold text-gray-500';
          dayElement.textContent = day;
          calendarDays.appendChild(dayElement);
        });
        
        // Add empty cells for days before first day of month
        for (let i = 0; i < firstDay.getDay(); i++) {
          const emptyElement = document.createElement('div');
          emptyElement.className = 'calendar-day disabled';
          calendarDays.appendChild(emptyElement);
        }
        
        // Add days of month
        for (let i = 1; i <= lastDay.getDate(); i++) {
          const dayDate = new Date(currentMonthYear.getFullYear(), currentMonthYear.getMonth(), i);
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          
          // Check if this is the selected date
          const isSelected = selectedDate && 
            dayDate.getDate() === selectedDate.getDate() &&
            dayDate.getMonth() === selectedDate.getMonth() &&
            dayDate.getFullYear() === selectedDate.getFullYear();
          
          if (isSelected) {
            dayElement.classList.add('selected');
          }
          
          dayElement.textContent = i;
          dayElement.addEventListener('click', () => {
            selectedDate = dayDate;
            selectedDateDisplay.textContent = formatDate(selectedDate);
            calendarPopup.classList.add('hidden');
            loadFilteredActivities();
          });
          calendarDays.appendChild(dayElement);
        }
      }
      
      // Toggle calendar popup
      calendarInput.addEventListener('click', () => {
        calendarPopup.classList.toggle('hidden');
      });
      
      // Previous month
      prevMonthBtn.addEventListener('click', () => {
        currentMonthYear.setMonth(currentMonthYear.getMonth() - 1);
        updateCalendar();
      });
      
      // Next month
      nextMonthBtn.addEventListener('click', () => {
        currentMonthYear.setMonth(currentMonthYear.getMonth() + 1);
        updateCalendar();
      });
      
      // Close calendar when clicking outside
      document.addEventListener('click', (event) => {
        if (!calendarInput.contains(event.target) && !calendarPopup.contains(event.target)) {
          calendarPopup.classList.add('hidden');
        }
      });
      
      // Initialize calendar
      updateCalendar();
    }

    // Load filtered activities
    async function loadFilteredActivities() {
      const filteredActivitiesList = document.getElementById('filteredActivitiesList');
      if (!filteredActivitiesList) return;

      try {
        const snapshot = await db.ref('running_logs').once('value');
        let activities = [];
        
        snapshot.forEach(childSnapshot => {
          const activity = childSnapshot.val();
          activity.id = childSnapshot.key;
          activities.push(activity);
        });

        // Filter by date
        activities = activities.filter(activity => {
          const activityDate = new Date(activity.date);
          return activityDate.toDateString() === selectedDate.toDateString();
        });

        // Filter by runner
        if (filterRunner !== 'all') {
          activities = activities.filter(activity => activity.bib_number === filterRunner);
        }

        // Sort by date (newest first)
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (activities.length === 0) {
          filteredActivitiesList.innerHTML = `
            <div class="text-center py-6">
              <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-gray-100 dark:bg-zinc-700 flex items-center justify-center">
                <i class="fas fa-search text-gray-400 text-xl"></i>
              </div>
              <p class="text-gray-500 dark:text-gray-400 font-medium">No activities found</p>
              <p class="text-sm text-gray-400 mt-1">Try changing your filters</p>
            </div>
          `;
          return;
        }

        filteredActivitiesList.innerHTML = activities.map(activity => {
          const activityDate = new Date(activity.date);
          const formattedTime = activityDate.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          return `
            <div class="p-3 bg-gray-50 dark:bg-zinc-700/50 rounded-xl">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-white text-xs font-bold">
                    ${activity.nickname ? activity.nickname.substring(0, 2).toUpperCase() : 'RU'}
                  </div>
                  <div>
                    <p class="text-sm font-bold dark:text-white">${activity.nickname || activity.runner_name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${activity.bib_number}</p>
                  </div>
                </div>
                <span class="text-xs text-gray-500 dark:text-gray-400">${formattedTime}</span>
              </div>
              
              <div class="grid grid-cols-3 gap-2 mt-3">
                <div class="text-center p-2 bg-white dark:bg-zinc-800 rounded-lg">
                  <p class="font-bold text-lg dark:text-white">${activity.distance}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Distance (km)</p>
                </div>
                <div class="text-center p-2 bg-white dark:bg-zinc-800 rounded-lg">
                  <p class="font-bold text-lg dark:text-white">${activity.duration}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Duration (min)</p>
                </div>
                <div class="text-center p-2 bg-white dark:bg-zinc-800 rounded-lg">
                  <p class="font-bold text-lg dark:text-white">${activity.pace}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Pace (min/km)</p>
                </div>
              </div>
              
              ${activity.notes ? `
                <div class="mt-3 p-2 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                  <p class="text-xs dark:text-white italic">"${activity.notes}"</p>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading filtered activities:', error);
        filteredActivitiesList.innerHTML = `
          <div class="text-center py-6">
            <p class="text-red-500">Error loading activities. Please try again.</p>
          </div>
        `;
      }
    }

    // Activity Feed Component
    async function renderActivityFeed(container) {
      container.innerHTML = `
        <div class="animate-fadeIn">
          <div class="flex justify-between items-center mb-4 sm:mb-6">
            <h2 class="text-xl sm:text-2xl font-black tracking-tight dark:text-white">Activity Feed</h2>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1.5 text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-full font-bold">
                Community
              </button>
            </div>
          </div>
          
          <div id="activityFeedList" class="space-y-4">
            <div class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-2 border-orange-600 border-t-transparent"></div>
              <p class="mt-3 text-gray-500 dark:text-gray-400">Loading activities...</p>
            </div>
          </div>
        </div>
      `;

      // Load activity feed
      loadActivityFeed();
    }

    // Load activity feed
    async function loadActivityFeed() {
      const activityFeedList = document.getElementById('activityFeedList');
      if (!activityFeedList) return;

      try {
        const snapshot = await db.ref('running_logs').orderByChild('date').limitToLast(20).once('value');
        const activities = [];
        
        snapshot.forEach(childSnapshot => {
          const activity = childSnapshot.val();
          activity.id = childSnapshot.key;
          activities.push(activity);
        });

        // Sort by date (newest first)
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (activities.length === 0) {
          activityFeedList.innerHTML = `
            <div class="text-center py-10">
              <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                <i class="fas fa-newspaper text-2xl text-orange-600 dark:text-orange-400"></i>
              </div>
              <h4 class="font-bold text-lg mb-2 dark:text-white">No activities yet</h4>
              <p class="text-gray-500 dark:text-gray-400 mb-6">Be the first to log an activity!</p>
            </div>
          `;
          return;
        }

        activityFeedList.innerHTML = activities.map(activity => {
          const activityDate = new Date(activity.date);
          const formattedDate = activityDate.toLocaleDateString('en-GB', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
          });
          const formattedTime = activityDate.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          const isCurrentUser = activity.bib_number === currentUser.bib_number;
          
          return `
            <div class="bg-white dark:bg-zinc-800 rounded-xl sm:rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-zinc-700">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-xl bg-gradient-to-tr ${isCurrentUser ? 'from-orange-600 to-amber-500' : 'from-blue-600 to-cyan-500'} flex items-center justify-center text-white font-bold">
                    ${activity.nickname ? activity.nickname.substring(0, 2).toUpperCase() : 'RU'}
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <h3 class="font-bold dark:text-white">${activity.nickname || activity.runner_name}</h3>
                      ${isCurrentUser ? `
                        <span class="px-1.5 py-0.5 bg-orange-600 text-white text-[8px] rounded-full uppercase">You</span>
                      ` : ''}
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${activity.bib_number}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-xs font-bold text-gray-500 dark:text-gray-400">${formattedDate}</p>
                  <p class="text-xs text-gray-400">${formattedTime}</p>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded text-xs font-bold uppercase">
                    ${activity.activity_type || 'Run'}
                  </span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">‚Ä¢ ${activity.distance} km ‚Ä¢ ${activity.duration} min</span>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                  <div class="text-center p-2 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                    <p class="text-lg font-black dark:text-white">${activity.distance}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Distance</p>
                  </div>
                  <div class="text-center p-2 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                    <p class="text-lg font-black dark:text-white">${activity.duration}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Duration</p>
                  </div>
                  <div class="text-center p-2 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                    <p class="text-lg font-black dark:text-white">${activity.pace}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Pace</p>
                  </div>
                </div>
              </div>
              
              ${activity.notes ? `
                <div class="mb-4 p-3 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                  <p class="text-sm dark:text-white italic">"${activity.notes}"</p>
                </div>
              ` : ''}
              
              <div class="flex items-center justify-between pt-3 border-t border-gray-100 dark:border-zinc-700">
                <div class="flex items-center gap-4">
                  <button 
                    data-activity-id="${activity.id}"
                    data-liked="${(activity.liked_by || []).includes(currentUser.bib_number)}"
                    class="like-btn flex items-center gap-1 text-xs font-bold ${(activity.liked_by || []).includes(currentUser.bib_number) ? 'text-red-500' : 'text-gray-500 hover:text-red-500'}"
                  >
                    <i class="fas fa-heart ${(activity.liked_by || []).includes(currentUser.bib_number) ? 'text-red-500' : 'text-gray-400'}"></i>
                    ${activity.likes || 0}
                  </button>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-2 h-2 rounded-full ${activity.status === 'approved' ? 'bg-green-500' : 'bg-yellow-500'}"></div>
                  <span class="text-xs text-gray-500 dark:text-gray-400">${activity.status || 'pending'}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Add like button listeners
        document.querySelectorAll('.like-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const activityId = btn.dataset.activityId;
            const isLiked = btn.dataset.liked === 'true';
            
            try {
              const activityRef = db.ref(`running_logs/${activityId}`);
              const snapshot = await activityRef.once('value');
              const activity = snapshot.val();
              
              let likedBy = activity.liked_by || [];
              let likes = activity.likes || 0;
              
              if (isLiked) {
                // Unlike
                likedBy = likedBy.filter(id => id !== currentUser.bib_number);
                likes = Math.max(0, likes - 1);
                btn.dataset.liked = 'false';
                btn.classList.remove('text-red-500');
                btn.classList.add('text-gray-500', 'hover:text-red-500');
                btn.querySelector('i').classList.remove('text-red-500');
                btn.querySelector('i').classList.add('text-gray-400');
              } else {
                // Like
                likedBy.push(currentUser.bib_number);
                likes += 1;
                btn.dataset.liked = 'true';
                btn.classList.add('text-red-500');
                btn.classList.remove('text-gray-500', 'hover:text-red-500');
                btn.querySelector('i').classList.add('text-red-500');
                btn.querySelector('i').classList.remove('text-gray-400');
              }
              
              await activityRef.update({
                liked_by: likedBy,
                likes: likes
              });
              
              btn.innerHTML = `
                <i class="fas fa-heart ${isLiked ? 'text-gray-400' : 'text-red-500'}"></i>
                ${likes}
              `;
            } catch (error) {
              console.error('Error updating like:', error);
            }
          });
        });
      } catch (error) {
        console.error('Error loading activity feed:', error);
        activityFeedList.innerHTML = `
          <div class="text-center py-10">
            <p class="text-red-500">Error loading activity feed. Please try again.</p>
          </div>
        `;
      }
    }

    // Ranking Component
    async function renderRanking(container) {
      container.innerHTML = `
        <div class="animate-fadeIn">
          <div class="flex justify-between items-center mb-4 sm:mb-6">
            <h2 class="text-xl sm:text-2xl font-black tracking-tight dark:text-white">Runners Ranking</h2>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1.5 text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-full font-bold">
                All Runners
              </button>
            </div>
          </div>
          
          <div class="bg-white dark:bg-zinc-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-zinc-700 overflow-hidden">
            <div class="p-3 sm:p-4 border-b border-gray-200 dark:border-zinc-700">
              <div class="grid grid-cols-12 gap-2 sm:gap-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">
                <div class="col-span-2 sm:col-span-1 text-center">Rank</div>
                <div class="col-span-4 sm:col-span-3">Runner</div>
                <div class="col-span-3 sm:col-span-2">Bib Number</div>
                <div class="col-span-3 sm:col-span-2 text-center">Distance</div>
                <div class="hidden sm:block col-span-2 text-center">Runs</div>
                <div class="hidden sm:block col-span-2 text-center">Pace</div>
              </div>
            </div>
            <div id="rankingList" class="divide-y divide-gray-100 dark:divide-zinc-700">
              <div class="p-4 text-center">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-orange-600 border-t-transparent"></div>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading rankings...</p>
              </div>
            </div>
          </div>
        </div>
      `;

      // Load rankings
      try {
        const snapshot = await db.ref('runners').once('value');
        const runners = [];
        
        snapshot.forEach(childSnapshot => {
          const runner = childSnapshot.val();
          runners.push(runner);
        });

        // Sort by total distance
        runners.sort((a, b) => (b.total_distance || 0) - (a.total_distance || 0));
        
        const rankingList = document.getElementById('rankingList');
        rankingList.innerHTML = '';
        
        runners.forEach((runner, index) => {
          const isCurrentUser = runner.bib_number === currentUser.bib_number;
          const rank = index + 1;
          
          let rankClass = 'text-gray-700 dark:text-gray-300';
          let rankIcon = '';
          
          if (rank === 1) {
            rankClass = 'crown-gold font-bold';
            rankIcon = 'üëë';
          } else if (rank === 2) {
            rankClass = 'crown-silver font-bold';
            rankIcon = 'ü•à';
          } else if (rank === 3) {
            rankClass = 'crown-bronze font-bold';
            rankIcon = 'ü•â';
          }
          
          const row = document.createElement('div');
          row.className = `p-3 sm:p-4 ${isCurrentUser ? 'bg-orange-50 dark:bg-orange-900/20' : ''} hover:bg-gray-50 dark:hover:bg-zinc-700/50 transition-colors`;
          row.innerHTML = `
            <div class="grid grid-cols-12 gap-2 sm:gap-4 items-center">
              <div class="col-span-2 sm:col-span-1 text-center">
                <div class="inline-flex items-center justify-center w-6 h-6 sm:w-8 sm:h-8 rounded-full ${rankClass} text-xs sm:text-sm">
                  ${rank} ${rankIcon}
                </div>
              </div>
              <div class="col-span-4 sm:col-span-3">
                <div class="flex items-center gap-2 sm:gap-3">
                  <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-tr ${isCurrentUser ? 'from-orange-600 to-amber-500' : 'from-blue-600 to-cyan-500'} flex items-center justify-center text-white text-xs sm:text-sm font-bold" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${RUNNER_BACKGROUND}') center/cover no-repeat;">
                    ${runner.nickname ? runner.nickname.substring(0, 2).toUpperCase() : 'RU'}
                  </div>
                  <div class="truncate">
                    <p class="font-bold dark:text-white text-xs sm:text-sm truncate">${runner.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">"${runner.nickname}"</p>
                  </div>
                </div>
              </div>
              <div class="col-span-3 sm:col-span-2">
                <span class="bib-number font-bold text-xs sm:text-sm dark:text-white">${runner.bib_number}</span>
              </div>
              <div class="col-span-3 sm:col-span-2 text-center">
                <p class="font-bold text-sm sm:text-lg dark:text-white">${(runner.total_distance || 0).toFixed(1)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">km</p>
              </div>
              <div class="hidden sm:block col-span-2 text-center">
                <p class="font-bold text-lg dark:text-white">${runner.total_runs || 0}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">runs</p>
              </div>
              <div class="hidden sm:block col-span-2 text-center">
                <p class="font-bold text-lg dark:text-white">${(runner.avg_pace || 0).toFixed(1)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">min/km</p>
              </div>
            </div>
          `;
          rankingList.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading rankings:', error);
        document.getElementById('rankingList').innerHTML = `
          <div class="p-4 sm:p-8 text-center">
            <p class="text-red-500">Error loading rankings. Please try again.</p>
          </div>
        `;
      }
    }

    // Leaderboard Component
    async function renderLeaderboard(container) {
      container.innerHTML = `
        <div class="animate-fadeIn">
          <div class="flex justify-between items-center mb-4 sm:mb-6">
            <h2 class="text-xl sm:text-2xl font-black tracking-tight dark:text-white">100km Leaderboard</h2>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1.5 text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-full font-bold">
                Top Performers
              </button>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-orange-500 to-amber-400 rounded-2xl sm:rounded-3xl p-4 sm:p-6 mb-4 sm:mb-6 shadow-lg">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg sm:text-xl font-black text-white">üèÜ Top 3 Champions üèÜ</h3>
                <p class="text-white/80 text-xs sm:text-sm">These runners have achieved the highest distances</p>
              </div>
              <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                <i class="fas fa-trophy text-xl sm:text-3xl text-white"></i>
              </div>
            </div>
          </div>
          
          <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <div class="p-4 text-center">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-orange-600 border-t-transparent"></div>
              <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading top performers...</p>
            </div>
          </div>
          
          <div class="bg-white dark:bg-zinc-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-zinc-700 overflow-hidden">
            <div class="p-3 sm:p-4 border-b border-gray-200 dark:border-zinc-700">
              <div class="grid grid-cols-12 gap-2 sm:gap-4 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">
                <div class="col-span-2 sm:col-span-1 text-center">Rank</div>
                <div class="col-span-5 sm:col-span-4">Runner</div>
                <div class="col-span-3 sm:col-span-3">Distance</div>
                <div class="col-span-2 sm:col-span-4">Progress</div>
              </div>
            </div>
            <div id="leaderboardList" class="divide-y divide-gray-100 dark:divide-zinc-700">
              <div class="p-4 text-center">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-orange-600 border-t-transparent"></div>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading leaderboard...</p>
              </div>
            </div>
          </div>
        </div>
      `;

      // Load leaderboard
      try {
        const snapshot = await db.ref('runners').once('value');
        const runners = [];
        
        snapshot.forEach(childSnapshot => {
          const runner = childSnapshot.val();
          runners.push(runner);
        });

        // Sort by total distance
        runners.sort((a, b) => (b.total_distance || 0) - (a.total_distance || 0));
        
        // Show top 3
        const top3Container = document.getElementById('top3Container');
        top3Container.innerHTML = '';
        
        const top3 = runners.slice(0, 3);
        const positions = ['1st', '2nd', '3rd'];
        const colors = ['gold', 'silver', 'bronze'];
        
        top3.forEach((runner, index) => {
          const position = positions[index];
          const color = colors[index];
          
          top3Container.innerHTML += `
            <div class="animate-fadeIn" style="animation-delay: ${index * 0.1}s">
              <div class="bg-white dark:bg-zinc-800 rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-lg border border-gray-200 dark:border-zinc-700 text-center">
                <div class="w-12 h-12 sm:w-16 sm:h-16 rounded-full medal-${color} flex items-center justify-center mx-auto mb-3 sm:mb-4 text-xl sm:text-2xl">
                  ${index === 0 ? 'üëë' : index === 1 ? 'ü•à' : 'ü•â'}
                </div>
                <div class="text-xl sm:text-3xl font-black mb-2 dark:text-white">${position}</div>
                <div class="bib-number text-base sm:text-xl font-bold text-orange-600 dark:text-orange-400 mb-2">${runner.bib_number}</div>
                <p class="font-bold dark:text-white text-sm sm:text-base mb-1">${runner.name}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3 sm:mb-4">"${runner.nickname}"</p>
                <div class="text-center">
                  <p class="text-xl sm:text-2xl font-black dark:text-white">${(runner.total_distance || 0).toFixed(1)}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Total Distance (km)</p>
                </div>
              </div>
            </div>
          `;
        });
        
        // Show full list
        const leaderboardList = document.getElementById('leaderboardList');
        leaderboardList.innerHTML = '';
        
        runners.forEach((runner, index) => {
          const rank = index + 1;
          const isCurrentUser = runner.bib_number === currentUser.bib_number;
          const progress = Math.min(100, Math.round((runner.total_distance || 0) / 100 * 100));
          
          const row = document.createElement('div');
          row.className = `p-3 sm:p-4 ${isCurrentUser ? 'bg-orange-50 dark:bg-orange-900/20' : ''} hover:bg-gray-50 dark:hover:bg-zinc-700/50 transition-colors`;
          row.innerHTML = `
            <div class="grid grid-cols-12 gap-2 sm:gap-4 items-center">
              <div class="col-span-2 sm:col-span-1 text-center">
                <div class="inline-flex items-center justify-center w-6 h-6 sm:w-8 sm:h-8 rounded-full ${
                  rank === 1 ? 'crown-gold' : 
                  rank === 2 ? 'crown-silver' : 
                  rank === 3 ? 'crown-bronze' : 
                  'bg-gray-100 dark:bg-zinc-700 text-gray-700 dark:text-gray-300'
                } font-bold text-xs sm:text-sm">
                  ${rank}
                </div>
              </div>
              <div class="col-span-5 sm:col-span-4">
                <div class="flex items-center gap-2 sm:gap-3">
                  <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-tr ${isCurrentUser ? 'from-orange-600 to-amber-500' : 'from-blue-600 to-cyan-500'} flex items-center justify-center text-white text-xs sm:text-sm font-bold" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${RUNNER_BACKGROUND}') center/cover no-repeat;">
                    ${runner.nickname ? runner.nickname.substring(0, 2).toUpperCase() : 'RU'}
                  </div>
                  <div class="truncate">
                    <p class="font-bold dark:text-white text-xs sm:text-sm truncate">${runner.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${runner.bib_number}</p>
                  </div>
                </div>
              </div>
              <div class="col-span-3 sm:col-span-3">
                <div class="flex items-center gap-2">
                  <div class="flex-1">
                    <p class="font-bold text-sm sm:text-lg dark:text-white">${(runner.total_distance || 0).toFixed(1)} km</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">${runner.total_runs || 0} runs</p>
                  </div>
                </div>
              </div>
              <div class="col-span-2 sm:col-span-4">
                <div class="space-y-1">
                  <div class="flex justify-between text-xs">
                    <span class="text-gray-500 dark:text-gray-400 hidden sm:inline">Progress</span>
                    <span class="font-bold dark:text-white">${progress}%</span>
                  </div>
                  <div class="w-full bg-gray-200 dark:bg-zinc-700 rounded-full h-1.5 sm:h-2">
                    <div class="bg-gradient-to-r from-orange-500 to-amber-400 h-1.5 sm:h-2 rounded-full" style="width: ${progress}%"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
          leaderboardList.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboardList').innerHTML = `
          <div class="p-4 sm:p-8 text-center">
            <p class="text-red-500">Error loading leaderboard. Please try again.</p>
          </div>
        `;
      }
    }

    // My Activities Component
    async function renderMyActivities(container) {
      container.innerHTML = `
        <div class="animate-fadeIn">
          <div class="flex justify-between items-center mb-4 sm:mb-6">
            <h2 class="text-xl sm:text-2xl font-black tracking-tight dark:text-white">My Activities</h2>
          </div>
          
          <div class="bg-white dark:bg-zinc-800 rounded-2xl sm:rounded-3xl shadow-sm border border-gray-200 dark:border-zinc-700 overflow-hidden">
            <div id="myActivitiesList" class="divide-y divide-gray-100 dark:divide-zinc-700">
              <div class="p-4 text-center">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-orange-600 border-t-transparent"></div>
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading your activities...</p>
              </div>
            </div>
          </div>
        </div>
      `;

      // Load user activities
      try {
        const snapshot = await db.ref('running_logs').orderByChild('bib_number').equalTo(currentUser.bib_number).once('value');
        const activities = [];
        
        snapshot.forEach(childSnapshot => {
          const activity = childSnapshot.val();
          activity.id = childSnapshot.key;
          activities.push(activity);
        });

        // Sort by date
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        const activitiesList = document.getElementById('myActivitiesList');
        
        if (activities.length === 0) {
          activitiesList.innerHTML = `
            <div class="p-6 sm:p-8 text-center">
              <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                <i class="fas fa-running text-2xl sm:text-3xl text-orange-600 dark:text-orange-400"></i>
              </div>
              <h4 class="font-bold text-lg mb-2 dark:text-white">No activities logged yet</h4>
              <p class="text-gray-500 dark:text-gray-400 mb-6 text-sm sm:text-base">Start your running journey by logging your first activity!</p>
              <button id="logFirstActivity" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl transition-all">
                Log Your First Activity
              </button>
            </div>
          `;
          
          document.getElementById('logFirstActivity')?.addEventListener('click', () => {
            isLogActivityModalOpen = true;
            renderLogActivityModal();
          });
        } else {
          activitiesList.innerHTML = '';
          
          activities.forEach(activity => {
            const activityDate = new Date(activity.date);
            const formattedDate = activityDate.toLocaleDateString('en-GB', { 
              day: 'numeric', 
              month: 'short', 
              year: 'numeric' 
            });
            const formattedTime = activityDate.toLocaleTimeString('en-GB', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            
            const activityCard = document.createElement('div');
            activityCard.className = 'p-4 sm:p-6 hover:bg-gray-50 dark:hover:bg-zinc-700/50 transition-colors';
            activityCard.innerHTML = `
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-orange-600 to-amber-500 flex items-center justify-center text-white">
                      <i class="fas fa-running"></i>
                    </div>
                    <div>
                      <h3 class="font-bold dark:text-white">${activity.activity_type || 'Run'} - ${activity.distance} km</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-400">${formattedDate} at ${formattedTime}</p>
                    </div>
                  </div>
                  <div class="grid grid-cols-3 gap-2 mt-3">
                    <div class="text-center p-2 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                      <p class="font-bold dark:text-white">${activity.duration}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">Minutes</p>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                      <p class="font-bold dark:text-white">${activity.pace}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">Pace</p>
                    </div>
                    <div class="text-center p-2 bg-gray-50 dark:bg-zinc-700/50 rounded-lg">
                      <p class="font-bold dark:text-white">${activity.likes || 0}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">Likes</p>
                    </div>
                  </div>
                  ${activity.notes ? `
                    <div class="mt-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                      <p class="text-sm dark:text-white italic">"${activity.notes}"</p>
                    </div>
                  ` : ''}
                </div>
                <div class="flex flex-col items-end gap-2">
                  <span class="px-3 py-1 rounded-full text-xs font-bold ${activity.status === 'approved' ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : activity.status === 'pending' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400' : 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400'}">
                    ${activity.status || 'pending'}
                  </span>
                </div>
              </div>
            `;
            activitiesList.appendChild(activityCard);
          });
        }
      } catch (error) {
        console.error('Error loading activities:', error);
        document.getElementById('myActivitiesList').innerHTML = `
          <div class="p-4 sm:p-8 text-center">
            <p class="text-red-500">Error loading activities. Please try again.</p>
          </div>
        `;
      }
    }

    // Log Activity Modal
    function renderLogActivityModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-[999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn';
      modal.innerHTML = `
        <div class="bg-white dark:bg-zinc-800 rounded-2xl sm:rounded-3xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-zinc-700">
          <div class="p-4 sm:p-6">
            <div class="flex items-center justify-between mb-4 sm:mb-6">
              <h2 class="text-xl font-black dark:text-white">Log New Activity</h2>
              <button id="closeModal" class="p-2 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-full text-gray-400">
                <i class="fas fa-times text-lg"></i>
              </button>
            </div>
            
            <form id="logActivityForm" class="space-y-4 sm:space-y-5">
              <!-- Activity Type -->
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Activity Type</label>
                <div class="grid grid-cols-2 gap-2">
                  <button type="button" data-type="run" class="activity-type-btn flex items-center justify-center gap-2 p-3 rounded-xl border-2 border-gray-200 dark:border-zinc-700 text-gray-600 dark:text-gray-400 transition-all">
                    <i class="fas fa-running"></i>
                    <span class="font-bold">Run</span>
                  </button>
                  <button type="button" data-type="walk" class="activity-type-btn flex items-center justify-center gap-2 p-3 rounded-xl border-2 border-gray-200 dark:border-zinc-700 text-gray-600 dark:text-gray-400 transition-all">
                    <i class="fas fa-walking"></i>
                    <span class="font-bold">Walk</span>
                  </button>
                </div>
              </div>
              
              <!-- Date -->
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Date</label>
                <input 
                  type="date" 
                  id="activityDate"
                  value="${new Date().toISOString().split('T')[0]}"
                  class="w-full bg-gray-50 dark:bg-zinc-700 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-orange-600 dark:text-white"
                  required
                />
              </div>
              
              <!-- Distance -->
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Distance (km)</label>
                <input 
                  type="number" 
                  step="0.1"
                  min="0.1"
                  id="distance"
                  placeholder="e.g., 5.0"
                  class="w-full bg-gray-50 dark:bg-zinc-700 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-orange-600 dark:text-white"
                  required
                />
              </div>
              
              <!-- Duration -->
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Duration (minutes)</label>
                <input 
                  type="number" 
                  min="1"
                  id="duration"
                  placeholder="e.g., 30"
                  class="w-full bg-gray-50 dark:bg-zinc-700 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-orange-600 dark:text-white"
                  required
                />
              </div>
              
              <!-- Pace (Auto-calculated) -->
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Average Pace (min/km)</label>
                <input 
                  type="number" 
                  step="0.1"
                  id="pace"
                  placeholder="Auto-calculated"
                  readonly
                  class="w-full bg-gray-100 dark:bg-zinc-600 border-none rounded-xl p-3 text-sm font-bold dark:text-white"
                />
              </div>
              
              <!-- Notes -->
              <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest mb-2">Notes (Optional)</label>
                <textarea 
                  id="notes"
                  rows="3"
                  placeholder="How was your run? Any milestones achieved?"
                  class="w-full bg-gray-50 dark:bg-zinc-700 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-orange-600 dark:text-white"
                ></textarea>
              </div>
              
              <!-- Submit Button -->
              <button 
                type="submit"
                id="submitActivityBtn"
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-black py-3 sm:py-4 rounded-xl shadow-xl shadow-orange-600/20 transition-all flex items-center justify-center gap-2"
              >
                <i class="fas fa-plus"></i>
                SUBMIT ACTIVITY
              </button>
            </form>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      const closeBtn = modal.querySelector('#closeModal');
      const activityTypeBtns = modal.querySelectorAll('.activity-type-btn');
      const distanceInput = modal.querySelector('#distance');
      const durationInput = modal.querySelector('#duration');
      const paceInput = modal.querySelector('#pace');
      const form = modal.querySelector('#logActivityForm');
      
      let selectedActivityType = 'run';
      
      // Set initial activity type
      activityTypeBtns[0].classList.add('active', 'border-orange-600', 'text-orange-600');
      
      // Activity type selection
      activityTypeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          selectedActivityType = btn.dataset.type;
          activityTypeBtns.forEach(b => {
            b.classList.remove('active', 'border-orange-600', 'text-orange-600');
          });
          btn.classList.add('active', 'border-orange-600', 'text-orange-600');
        });
      });
      
      // Auto-calculate pace
      function calculatePace() {
        const distance = parseFloat(distanceInput.value);
        const duration = parseFloat(durationInput.value);
        
        if (distance > 0 && duration > 0) {
          const pace = duration / distance;
          paceInput.value = pace.toFixed(2);
        } else {
          paceInput.value = '';
        }
      }
      
      distanceInput.addEventListener('input', calculatePace);
      durationInput.addEventListener('input', calculatePace);
      
      // Close modal
      closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
        isLogActivityModalOpen = false;
      });
      
      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = modal.querySelector('#submitActivityBtn');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div> Processing...';
        
        try {
          // Validate inputs
          const distance = parseFloat(distanceInput.value);
          const duration = parseFloat(durationInput.value);
          const pace = parseFloat(paceInput.value);
          const date = modal.querySelector('#activityDate').value;
          const notes = modal.querySelector('#notes').value;
          
          if (!distance || !duration || !pace || !date) {
            throw new Error('Please fill all required fields');
          }
          
          // Save activity to database
          const activityData = {
            bib_number: currentUser.bib_number,
            runner_name: currentUser.name,
            nickname: currentUser.nickname,
            date: date,
            distance: distance,
            duration: duration,
            pace: pace,
            activity_type: selectedActivityType,
            notes: notes || null,
            status: 'pending',
            submission_date: new Date().toISOString(),
            likes: 0,
            liked_by: []
          };
          
          const activityRef = await db.ref('running_logs').push(activityData);
          
          // Update user stats
          const userRef = db.ref(`runners/${currentUser.bib_number}`);
          const userSnapshot = await userRef.once('value');
          const userData = userSnapshot.val();
          
          const newTotalRuns = (userData.total_runs || 0) + 1;
          const newTotalDistance = (userData.total_distance || 0) + distance;
          const newAvgPace = ((userData.avg_pace || 0) * (newTotalRuns - 1) + pace) / newTotalRuns;
          
          await userRef.update({
            total_runs: newTotalRuns,
            total_distance: newTotalDistance,
            avg_pace: newAvgPace.toFixed(2),
            last_activity_date: new Date().toISOString()
          });
          
          // Update current user data
          currentUser.total_runs = newTotalRuns;
          currentUser.total_distance = newTotalDistance;
          currentUser.avg_pace = newAvgPace.toFixed(2);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Success message
          alert('Activity logged successfully! It will be reviewed and approved soon.');
          
          // Close modal
          document.body.removeChild(modal);
          isLogActivityModalOpen = false;
          
          // Refresh current tab and sidebar
          renderContent();
          loadSidebarActivities();
          
        } catch (error) {
          alert('Error: ' + error.message);
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
      
      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
          isLogActivityModalOpen = false;
        }
      });
    }

    // Utility Functions
    function toggleSidebar() {
      isSidebarOpen = !isSidebarOpen;
      renderMainApp();
    }

    function handleLogout() {
      auth.signOut();
      localStorage.removeItem('currentUser');
      currentUser = null;
      renderLogin();
    }

    function updateSidebarButtons() {
      // Update sidebar tab buttons
      document.querySelectorAll('.sidebar-tab-btn').forEach(btn => {
        const tabId = btn.dataset.tab;
        if (tabId === activeTab) {
          btn.classList.add('bg-orange-600', 'text-white', 'shadow-lg', 'shadow-orange-600/20');
          btn.classList.remove('text-gray-400', 'hover:bg-zinc-800', 'hover:text-white');
        } else {
          btn.classList.remove('bg-orange-600', 'text-white', 'shadow-lg', 'shadow-orange-600/20');
          btn.classList.add('text-gray-400', 'hover:bg-zinc-800', 'hover:text-white');
        }
      });

      // Update mobile tab buttons
      document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
        const tabId = btn.dataset.tab;
        if (tabId === activeTab) {
          btn.classList.add('text-orange-600');
          btn.classList.remove('text-gray-500', 'dark:text-gray-400');
        } else {
          btn.classList.remove('text-orange-600');
          btn.classList.add('text-gray-500', 'dark:text-gray-400');
        }
      });

      // Add sidebar logout listener
      const sidebarLogout = document.getElementById('sidebarLogout');
      if (sidebarLogout) {
        sidebarLogout.addEventListener('click', handleLogout);
      }

      // Add sidebar tab listeners
      document.querySelectorAll('.sidebar-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          activeTab = btn.dataset.tab;
          isSidebarOpen = false;
          renderMainApp();
        });
      });

      // Add sidebar overlay listener
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) {
        overlay.addEventListener('click', () => {
          isSidebarOpen = false;
          renderMainApp();
        });
      }
    }

    // Initialize the application
    initApp();
  </script>
  
</body>

</html>
